(()=>{var e={815:function(e,t){var r,n;"undefined"!=typeof globalThis?globalThis:"undefined"!=typeof self&&self,r=function(e){"use strict";if(!(globalThis.chrome&&globalThis.chrome.runtime&&globalThis.chrome.runtime.id))throw new Error("This script should only be loaded in a browser extension.");if(globalThis.browser&&globalThis.browser.runtime&&globalThis.browser.runtime.id)e.exports=globalThis.browser;else{const t="The message port closed before a response was received.",r=e=>{const r={alarms:{clear:{minArgs:0,maxArgs:1},clearAll:{minArgs:0,maxArgs:0},get:{minArgs:0,maxArgs:1},getAll:{minArgs:0,maxArgs:0}},bookmarks:{create:{minArgs:1,maxArgs:1},get:{minArgs:1,maxArgs:1},getChildren:{minArgs:1,maxArgs:1},getRecent:{minArgs:1,maxArgs:1},getSubTree:{minArgs:1,maxArgs:1},getTree:{minArgs:0,maxArgs:0},move:{minArgs:2,maxArgs:2},remove:{minArgs:1,maxArgs:1},removeTree:{minArgs:1,maxArgs:1},search:{minArgs:1,maxArgs:1},update:{minArgs:2,maxArgs:2}},browserAction:{disable:{minArgs:0,maxArgs:1,fallbackToNoCallback:!0},enable:{minArgs:0,maxArgs:1,fallbackToNoCallback:!0},getBadgeBackgroundColor:{minArgs:1,maxArgs:1},getBadgeText:{minArgs:1,maxArgs:1},getPopup:{minArgs:1,maxArgs:1},getTitle:{minArgs:1,maxArgs:1},openPopup:{minArgs:0,maxArgs:0},setBadgeBackgroundColor:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setBadgeText:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setIcon:{minArgs:1,maxArgs:1},setPopup:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setTitle:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0}},browsingData:{remove:{minArgs:2,maxArgs:2},removeCache:{minArgs:1,maxArgs:1},removeCookies:{minArgs:1,maxArgs:1},removeDownloads:{minArgs:1,maxArgs:1},removeFormData:{minArgs:1,maxArgs:1},removeHistory:{minArgs:1,maxArgs:1},removeLocalStorage:{minArgs:1,maxArgs:1},removePasswords:{minArgs:1,maxArgs:1},removePluginData:{minArgs:1,maxArgs:1},settings:{minArgs:0,maxArgs:0}},commands:{getAll:{minArgs:0,maxArgs:0}},contextMenus:{remove:{minArgs:1,maxArgs:1},removeAll:{minArgs:0,maxArgs:0},update:{minArgs:2,maxArgs:2}},cookies:{get:{minArgs:1,maxArgs:1},getAll:{minArgs:1,maxArgs:1},getAllCookieStores:{minArgs:0,maxArgs:0},remove:{minArgs:1,maxArgs:1},set:{minArgs:1,maxArgs:1}},devtools:{inspectedWindow:{eval:{minArgs:1,maxArgs:2,singleCallbackArg:!1}},panels:{create:{minArgs:3,maxArgs:3,singleCallbackArg:!0},elements:{createSidebarPane:{minArgs:1,maxArgs:1}}}},downloads:{cancel:{minArgs:1,maxArgs:1},download:{minArgs:1,maxArgs:1},erase:{minArgs:1,maxArgs:1},getFileIcon:{minArgs:1,maxArgs:2},open:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},pause:{minArgs:1,maxArgs:1},removeFile:{minArgs:1,maxArgs:1},resume:{minArgs:1,maxArgs:1},search:{minArgs:1,maxArgs:1},show:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0}},extension:{isAllowedFileSchemeAccess:{minArgs:0,maxArgs:0},isAllowedIncognitoAccess:{minArgs:0,maxArgs:0}},history:{addUrl:{minArgs:1,maxArgs:1},deleteAll:{minArgs:0,maxArgs:0},deleteRange:{minArgs:1,maxArgs:1},deleteUrl:{minArgs:1,maxArgs:1},getVisits:{minArgs:1,maxArgs:1},search:{minArgs:1,maxArgs:1}},i18n:{detectLanguage:{minArgs:1,maxArgs:1},getAcceptLanguages:{minArgs:0,maxArgs:0}},identity:{launchWebAuthFlow:{minArgs:1,maxArgs:1}},idle:{queryState:{minArgs:1,maxArgs:1}},management:{get:{minArgs:1,maxArgs:1},getAll:{minArgs:0,maxArgs:0},getSelf:{minArgs:0,maxArgs:0},setEnabled:{minArgs:2,maxArgs:2},uninstallSelf:{minArgs:0,maxArgs:1}},notifications:{clear:{minArgs:1,maxArgs:1},create:{minArgs:1,maxArgs:2},getAll:{minArgs:0,maxArgs:0},getPermissionLevel:{minArgs:0,maxArgs:0},update:{minArgs:2,maxArgs:2}},pageAction:{getPopup:{minArgs:1,maxArgs:1},getTitle:{minArgs:1,maxArgs:1},hide:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setIcon:{minArgs:1,maxArgs:1},setPopup:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setTitle:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},show:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0}},permissions:{contains:{minArgs:1,maxArgs:1},getAll:{minArgs:0,maxArgs:0},remove:{minArgs:1,maxArgs:1},request:{minArgs:1,maxArgs:1}},runtime:{getBackgroundPage:{minArgs:0,maxArgs:0},getPlatformInfo:{minArgs:0,maxArgs:0},openOptionsPage:{minArgs:0,maxArgs:0},requestUpdateCheck:{minArgs:0,maxArgs:0},sendMessage:{minArgs:1,maxArgs:3},sendNativeMessage:{minArgs:2,maxArgs:2},setUninstallURL:{minArgs:1,maxArgs:1}},sessions:{getDevices:{minArgs:0,maxArgs:1},getRecentlyClosed:{minArgs:0,maxArgs:1},restore:{minArgs:0,maxArgs:1}},storage:{local:{clear:{minArgs:0,maxArgs:0},get:{minArgs:0,maxArgs:1},getBytesInUse:{minArgs:0,maxArgs:1},remove:{minArgs:1,maxArgs:1},set:{minArgs:1,maxArgs:1}},managed:{get:{minArgs:0,maxArgs:1},getBytesInUse:{minArgs:0,maxArgs:1}},sync:{clear:{minArgs:0,maxArgs:0},get:{minArgs:0,maxArgs:1},getBytesInUse:{minArgs:0,maxArgs:1},remove:{minArgs:1,maxArgs:1},set:{minArgs:1,maxArgs:1}}},tabs:{captureVisibleTab:{minArgs:0,maxArgs:2},create:{minArgs:1,maxArgs:1},detectLanguage:{minArgs:0,maxArgs:1},discard:{minArgs:0,maxArgs:1},duplicate:{minArgs:1,maxArgs:1},executeScript:{minArgs:1,maxArgs:2},get:{minArgs:1,maxArgs:1},getCurrent:{minArgs:0,maxArgs:0},getZoom:{minArgs:0,maxArgs:1},getZoomSettings:{minArgs:0,maxArgs:1},goBack:{minArgs:0,maxArgs:1},goForward:{minArgs:0,maxArgs:1},highlight:{minArgs:1,maxArgs:1},insertCSS:{minArgs:1,maxArgs:2},move:{minArgs:2,maxArgs:2},query:{minArgs:1,maxArgs:1},reload:{minArgs:0,maxArgs:2},remove:{minArgs:1,maxArgs:1},removeCSS:{minArgs:1,maxArgs:2},sendMessage:{minArgs:2,maxArgs:3},setZoom:{minArgs:1,maxArgs:2},setZoomSettings:{minArgs:1,maxArgs:2},update:{minArgs:1,maxArgs:2}},topSites:{get:{minArgs:0,maxArgs:0}},webNavigation:{getAllFrames:{minArgs:1,maxArgs:1},getFrame:{minArgs:1,maxArgs:1}},webRequest:{handlerBehaviorChanged:{minArgs:0,maxArgs:0}},windows:{create:{minArgs:0,maxArgs:1},get:{minArgs:1,maxArgs:2},getAll:{minArgs:0,maxArgs:1},getCurrent:{minArgs:0,maxArgs:1},getLastFocused:{minArgs:0,maxArgs:1},remove:{minArgs:1,maxArgs:1},update:{minArgs:2,maxArgs:2}}};if(0===Object.keys(r).length)throw new Error("api-metadata.json has not been included in browser-polyfill");class n extends WeakMap{constructor(e,t=void 0){super(t),this.createItem=e}get(e){return this.has(e)||this.set(e,this.createItem(e)),super.get(e)}}const s=(t,r)=>(...n)=>{e.runtime.lastError?t.reject(new Error(e.runtime.lastError.message)):r.singleCallbackArg||n.length<=1&&!1!==r.singleCallbackArg?t.resolve(n[0]):t.resolve(n)},o=e=>1==e?"argument":"arguments",a=(e,t,r)=>new Proxy(t,{apply:(t,n,s)=>r.call(n,e,...s)});let i=Function.call.bind(Object.prototype.hasOwnProperty);const l=(e,t={},r={})=>{let n=Object.create(null),c={has:(t,r)=>r in e||r in n,get(c,g,m){if(g in n)return n[g];if(!(g in e))return;let u=e[g];if("function"==typeof u)if("function"==typeof t[g])u=a(e,e[g],t[g]);else if(i(r,g)){let t=((e,t)=>function(r,...n){if(n.length<t.minArgs)throw new Error(`Expected at least ${t.minArgs} ${o(t.minArgs)} for ${e}(), got ${n.length}`);if(n.length>t.maxArgs)throw new Error(`Expected at most ${t.maxArgs} ${o(t.maxArgs)} for ${e}(), got ${n.length}`);return new Promise((o,a)=>{if(t.fallbackToNoCallback)try{r[e](...n,s({resolve:o,reject:a},t))}catch(s){console.warn(`${e} API method doesn't seem to support the callback parameter, falling back to call it without a callback: `,s),r[e](...n),t.fallbackToNoCallback=!1,t.noCallback=!0,o()}else t.noCallback?(r[e](...n),o()):r[e](...n,s({resolve:o,reject:a},t))})})(g,r[g]);u=a(e,e[g],t)}else u=u.bind(e);else if("object"==typeof u&&null!==u&&(i(t,g)||i(r,g)))u=l(u,t[g],r[g]);else{if(!i(r,"*"))return Object.defineProperty(n,g,{configurable:!0,enumerable:!0,get:()=>e[g],set(t){e[g]=t}}),u;u=l(u,t[g],r["*"])}return n[g]=u,u},set:(t,r,s,o)=>(r in n?n[r]=s:e[r]=s,!0),defineProperty:(e,t,r)=>Reflect.defineProperty(n,t,r),deleteProperty:(e,t)=>Reflect.deleteProperty(n,t)},g=Object.create(e);return new Proxy(g,c)},c=e=>({addListener(t,r,...n){t.addListener(e.get(r),...n)},hasListener:(t,r)=>t.hasListener(e.get(r)),removeListener(t,r){t.removeListener(e.get(r))}}),g=new n(e=>"function"!=typeof e?e:function(t){const r=l(t,{},{getContent:{minArgs:0,maxArgs:0}});e(r)}),m=new n(e=>"function"!=typeof e?e:function(t,r,n){let s,o,a=!1,i=new Promise(e=>{s=function(t){a=!0,e(t)}});try{o=e(t,r,s)}catch(e){o=Promise.reject(e)}const l=!0!==o&&((c=o)&&"object"==typeof c&&"function"==typeof c.then);var c;if(!0!==o&&!l&&!a)return!1;return(l?o:i).then(e=>{n(e)},e=>{let t;t=e&&(e instanceof Error||"string"==typeof e.message)?e.message:"An unexpected error occurred",n({__mozWebExtensionPolyfillReject__:!0,message:t})}).catch(e=>{console.error("Failed to send onMessage rejected reply",e)}),!0}),u=({reject:r,resolve:n},s)=>{e.runtime.lastError?e.runtime.lastError.message===t?n():r(new Error(e.runtime.lastError.message)):s&&s.__mozWebExtensionPolyfillReject__?r(new Error(s.message)):n(s)},d=(e,t,r,...n)=>{if(n.length<t.minArgs)throw new Error(`Expected at least ${t.minArgs} ${o(t.minArgs)} for ${e}(), got ${n.length}`);if(n.length>t.maxArgs)throw new Error(`Expected at most ${t.maxArgs} ${o(t.maxArgs)} for ${e}(), got ${n.length}`);return new Promise((e,t)=>{const s=u.bind(null,{resolve:e,reject:t});n.push(s),r.sendMessage(...n)})},A={devtools:{network:{onRequestFinished:c(g)}},runtime:{onMessage:c(m),onMessageExternal:c(m),sendMessage:d.bind(null,"sendMessage",{minArgs:1,maxArgs:3})},tabs:{sendMessage:d.bind(null,"sendMessage",{minArgs:2,maxArgs:3})}},h={clear:{minArgs:1,maxArgs:1},get:{minArgs:1,maxArgs:1},set:{minArgs:1,maxArgs:1}};return r.privacy={network:{"*":h},services:{"*":h},websites:{"*":h}},l(e,A,r)};e.exports=r(chrome)}},void 0===(n=r.apply(t,[e]))||(e.exports=n)}},t={};function r(n){var s=t[n];if(void 0!==s)return s.exports;var o=t[n]={exports:{}};return e[n].call(o.exports,o,o.exports,r),o.exports}r.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return r.d(t,{a:t}),t},r.d=(e,t)=>{for(var n in t)r.o(t,n)&&!r.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},r.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),(()=>{"use strict";var e=r(815),t=r.n(e);class n extends Error{constructor(e){super(e),this.name="EdgeTTSException"}}class s extends n{constructor(e){super(e),this.name="SkewAdjustmentError"}}class o extends n{constructor(e){super(e),this.name="UnknownResponse"}}class a extends n{constructor(e){super(e),this.name="UnexpectedResponse"}}class i extends n{constructor(e){super(e),this.name="NoAudioReceived"}}class l extends n{constructor(e){super(e),this.name="WebSocketError"}}class c extends n{constructor(e){super(e),this.name="ValueError"}}function g(){const e=new Uint8Array(16);globalThis.crypto.getRandomValues(e),e[6]=15&e[6]|64,e[8]=63&e[8]|128;const t=Array.from(e,e=>e.toString(16).padStart(2,"0")).join("");return`${t.slice(0,8)}-${t.slice(8,12)}-${t.slice(12,16)}-${t.slice(16,20)}-${t.slice(20,32)}`.replace(/-/g,"")}function m(e){return e.replace(/&quot;/g,'"').replace(/&apos;/g,"'").replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&amp;/g,"&")}function u(e){return e||(e=new Date),e.toISOString().replace(/[-:.]/g,"").slice(0,-1)}class d{constructor({voice:e,rate:t="+0%",volume:r="+0%",pitch:n="+0Hz"}){this.voice=e,this.rate=t,this.volume=r,this.pitch=n,this.validate()}validate(){const e=/^([a-z]{2,})-([A-Z]{2,})-(.+Neural)$/.exec(this.voice);if(e){const[,t]=e;let[,,r,n]=e;if(n.includes("-")){const e=n.split("-");r+=`-${e[0]}`,n=e[1]}this.voice=`Microsoft Server Speech Text to Speech Voice (${t}-${r}, ${n})`}d.validateStringParam("voice",this.voice,/^Microsoft Server Speech Text to Speech Voice \(.+,.+\)$/),d.validateStringParam("rate",this.rate,/^[+-]\d+%$/),d.validateStringParam("volume",this.volume,/^[+-]\d+%$/),d.validateStringParam("pitch",this.pitch,/^[+-]\d+Hz$/)}static validateStringParam(e,t,r){if("string"!=typeof t)throw new TypeError(`${e} must be a string`);if(!r.test(t))throw new c(`Invalid ${e} '${t}'.`)}}const A="6A5AA1D4EAFF4E9FB37E23D68491D6F4",h=`wss://speech.platform.bing.com/consumer/speech/synthesize/readaloud/edge/v1?TrustedClientToken=${A}`,f="130.0.2849.68",p=f.split(".")[0],x=`1-${f}`,v={"User-Agent":`Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/${p}.0.0.0 Safari/537.36 Edg/${p}.0.0.0`,"Accept-Encoding":"gzip, deflate, br","Accept-Language":"en-US,en;q=0.9"};Object.assign(Object.assign({},v),{Pragma:"no-cache","Cache-Control":"no-cache",Origin:"chrome-extension://jdiccldimpdaibmpdkjnbmckianbfold"}),Object.assign(Object.assign({},v),{Authority:"speech.platform.bing.com","Sec-CH-UA":`" Not;A Brand";v="99", "Microsoft Edge";v="${p}", "Chromium";v="${p}"`,"Sec-CH-UA-Mobile":"?0",Accept:"*/*","Sec-Fetch-Site":"none","Sec-Fetch-Mode":"cors","Sec-Fetch-Dest":"empty"});class y{static adjClockSkewSeconds(e){y.clockSkewSeconds+=e}static getUnixTimestamp(){return Date.now()/1e3+y.clockSkewSeconds}static parseRfc2616Date(e){try{return new Date(e).getTime()/1e3}catch(e){return null}}static handleClientResponseError(e){if(!e.headers)throw new s("No headers in response.");const t=e.headers.date||e.headers.Date;if(!t)throw new s("No server date in headers.");const r=y.parseRfc2616Date(t);if(null===r)throw new s(`Failed to parse server date: ${t}`);const n=y.getUnixTimestamp();y.adjClockSkewSeconds(r-n)}static generateSecMsGec(){return e=this,t=void 0,n=function*(){let e=y.getUnixTimestamp();e+=11644473600,e-=e%300,e*=1e7;const t=`${e.toFixed(0)}${A}`,r=(new TextEncoder).encode(t),n=yield crypto.subtle.digest("SHA-256",r);return Array.from(new Uint8Array(n)).map(e=>e.toString(16).padStart(2,"0")).join("").toUpperCase()},new((r=void 0)||(r=Promise))(function(s,o){function a(e){try{l(n.next(e))}catch(e){o(e)}}function i(e){try{l(n.throw(e))}catch(e){o(e)}}function l(e){var t;e.done?s(e.value):(t=e.value,t instanceof r?t:new r(function(e){e(t)})).then(a,i)}l((n=n.apply(e,t||[])).next())});var e,t,r,n}}y.clockSkewSeconds=0;const w=()=>navigator.userAgent.includes("Firefox");var b=function(e){return this instanceof b?(this.v=e,this):new b(e)},T=function(e,t,r){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var n,s=r.apply(e,t||[]),o=[];return n=Object.create(("function"==typeof AsyncIterator?AsyncIterator:Object).prototype),a("next"),a("throw"),a("return",function(e){return function(t){return Promise.resolve(t).then(e,c)}}),n[Symbol.asyncIterator]=function(){return this},n;function a(e,t){s[e]&&(n[e]=function(t){return new Promise(function(r,n){o.push([e,t,r,n])>1||i(e,t)})},t&&(n[e]=t(n[e])))}function i(e,t){try{(r=s[e](t)).value instanceof b?Promise.resolve(r.value.v).then(l,c):g(o[0][2],r)}catch(e){g(o[0][3],e)}var r}function l(e){i("next",e)}function c(e){i("throw",e)}function g(e,t){e(t),o.shift(),o.length&&i(o[0][0],o[0][1])}},E=function(e){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var t,r=e[Symbol.asyncIterator];return r?r.call(e):(e="function"==typeof __values?__values(e):e[Symbol.iterator](),t={},n("next"),n("throw"),n("return"),t[Symbol.asyncIterator]=function(){return this},t);function n(r){t[r]=e[r]&&function(t){return new Promise(function(n,s){!function(e,t,r,n){Promise.resolve(n).then(function(t){e({value:t,done:r})},t)}(n,s,(t=e[r](t)).done,t.value)})}}};class S{static from(e,t){if("string"==typeof e)return(new TextEncoder).encode(e);if(e instanceof Uint8Array)return e;if(e instanceof ArrayBuffer)return new Uint8Array(e);if(e&&"object"==typeof e&&"byteLength"in e)return new Uint8Array(e);throw console.error("BrowserBuffer.from received unexpected input type:",typeof e,e),new Error("Unsupported input type for BrowserBuffer.from: "+typeof e)}static concat(e){const t=e.reduce((e,t)=>e+t.length,0),r=new Uint8Array(t);let n=0;for(const t of e)r.set(t,n),n+=t.length;return r}}function k(e){if(e.length<2)throw new Error("Message too short to contain header length");const t=e[0]<<8|e[1],r={};if(t>0&&t+2<=e.length){const n=e.slice(2,t+2),s=(new TextDecoder).decode(n).split("\r\n");for(const e of s){const[t,n]=e.split(":",2);t&&n&&(r[t]=n.trim())}}return[r,e.slice(t+2)]}class P{constructor(e,t={}){if(this.state={partialText:S.from(""),offsetCompensation:0,lastDurationOffset:0,streamWasCalled:!1},this.ttsConfig=new d({voice:t.voice||"en-US-EmmaMultilingualNeural",rate:t.rate,volume:t.volume,pitch:t.pitch}),"string"!=typeof e)throw new TypeError("text must be a string");const r=w()?32768:4096;this.texts=function(e,t){return function*(){let r=(new TextEncoder).encode(e);if(t<=0)throw new Error("byteLength must be greater than 0");for(;r.length>t;){let e=t;const n=r.slice(0,t),s=(new TextDecoder).decode(n),o=s.lastIndexOf("\n"),a=s.lastIndexOf(" ");o>0?e=(new TextEncoder).encode(s.substring(0,o)).length:a>0&&(e=(new TextEncoder).encode(s.substring(0,a)).length);const i=r.slice(0,e),l=(new TextDecoder).decode(i).trim();l&&(yield(new TextEncoder).encode(l)),r=r.slice(e)}const n=(new TextDecoder).decode(r).trim();n&&(yield(new TextEncoder).encode(n))}()}(function(e){return e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&apos;")}(function(e){let t=e;for(const e of'*/()[]{}$%^@#+=|\\~`><"&')t=t.replace(new RegExp("\\"+e,"g"),"");return t}(e)),r),this.connectionTimeout=t.connectionTimeout}parseMetadata(e){const t=JSON.parse((new TextDecoder).decode(e));for(const e of t.Metadata){const t=e.Type;if("WordBoundary"===t)return{type:t,offset:e.Data.Offset+this.state.offsetCompensation,duration:e.Data.Duration,text:m(e.Data.text.Text)};if("SessionEnd"!==t)throw new o(`Unknown metadata type: ${t}`)}throw new a("No WordBoundary metadata found")}_stream(){return T(this,arguments,function*(){const e=`${h}&Sec-MS-GEC=${yield b(y.generateSecMsGec())}&Sec-MS-GEC-Version=${x}&ConnectionId=${g()}`,t=new WebSocket(e),r=[];let n,s=null;this.connectionTimeout&&(n=window.setTimeout(()=>{t.close(),r.push(new l("Connection timeout")),s&&s()},this.connectionTimeout)),t.onmessage=e=>{n&&(window.clearTimeout(n),n=void 0);const i=e.data;if(i instanceof ArrayBuffer||Blob,"string"==typeof i){const[e,n]=function(e){const t=(new TextDecoder).decode(e),r=t.indexOf("\r\n\r\n"),n={};if(-1!==r){const e=t.substring(0,r).split("\r\n");for(const t of e){const[e,r]=t.split(":",2);e&&r&&(n[e]=r.trim())}}const s=(new TextEncoder).encode(t.substring(0,r+4)).length;return[n,e.slice(s)]}(S.from(i)),s=e.Path;if("audio.metadata"===s)try{const e=this.parseMetadata(n);this.state.lastDurationOffset=e.offset+e.duration,r.push(e)}catch(e){r.push(e)}else"turn.end"===s?(this.state.offsetCompensation=this.state.lastDurationOffset,t.close()):"response"!==s&&"turn.start"!==s&&r.push(new o(`Unknown path received: ${s}`))}else if(i instanceof ArrayBuffer){const e=S.from(i);if(e.length<2)r.push(new a("We received a binary message, but it is missing the header length."));else{const[t,n]=k(e);if("audio"!==t.Path)r.push(new a("Received binary message, but the path is not audio."));else{const e=t["Content-Type"]||"";"audio/mpeg"!==e&&!e.startsWith("audio/webm")&&"audio/webm"!==e&&e?n.length>0&&r.push(new a(`Received binary message with unexpected Content-Type: ${e}`)):0===n.length||r.push({type:"audio",data:n})}}}else if(i instanceof Blob){const e=new FileReader;return e.onload=()=>{try{const t=e.result,n=t.byteLength,s=new Uint8Array(n),o=new Uint8Array(t);for(let e=0;e<n;e++)s[e]=o[e];if(s.length<2)r.push(new a("We received a binary message, but it is missing the header length."));else{const[e,t]=k(s);if("audio"!==e.Path)r.push(new a("Received binary message, but the path is not audio."));else{const n=e["Content-Type"]||"";"audio/mpeg"!==n&&!n.startsWith("audio/webm")&&"audio/webm"!==n&&n?t.length>0&&r.push(new a(`Received binary message with unexpected Content-Type: ${n}`)):0===t.length||r.push({type:"audio",data:t})}}}catch(e){console.error("Error processing Blob data:",e),r.push(new a(`Failed to process Blob: ${e}`))}s&&(s(),s=null)},e.onerror=()=>{console.error("FileReader error:",e.error),r.push(new a("Failed to read Blob data")),s&&(s(),s=null)},void e.readAsArrayBuffer(i)}s&&s()},t.onerror=e=>{n&&(window.clearTimeout(n),n=void 0),r.push(new l("WebSocket error occurred")),s&&s()},t.onclose=()=>{n&&(window.clearTimeout(n),n=void 0),r.push("close"),s&&s()},yield b(new Promise((e,r)=>{t.onopen=()=>{n&&(window.clearTimeout(n),n=void 0),e()},this.connectionTimeout&&setTimeout(()=>{t.readyState===WebSocket.CONNECTING&&(t.close(),r(new l("Connection timeout")))},this.connectionTimeout)}));const c=w()?"webm-24khz-16bit-mono-opus":"audio-24khz-48kbitrate-mono-mp3";var m,d,A;t.send(`X-Timestamp:${u()}\r\nContent-Type:application/json; charset=utf-8\r\nPath:speech.config\r\n\r\n{"context":{"synthesis":{"audio":{"metadataoptions":{"sentenceBoundaryEnabled":"false","wordBoundaryEnabled":"true"},"outputFormat":"${c}"}}}}\r\n`),t.send((m=g(),d=u(),A=function(e,t){const r=t instanceof Uint8Array?(new TextDecoder).decode(t):t;return`<speak version='1.0' xmlns='http://www.w3.org/2001/10/synthesis' xml:lang='en-US'><voice name='${e.voice}'><prosody pitch='${e.pitch}' rate='${e.rate}' volume='${e.volume}'>${r}</prosody></voice></speak>`}(this.ttsConfig,(new TextDecoder).decode(this.state.partialText)),`X-RequestId:${m}\r\nContent-Type:application/ssml+xml\r\nX-Timestamp:${d}Z\r\nPath:ssml\r\n\r\n${A}`));let f=!1;for(;;)if(r.length>0){const e=r.shift();if("close"===e){if(!f)throw new i("No audio was received.");break}if(e instanceof Error)throw e;"audio"===e.type&&(f=!0),yield yield b(e)}else yield b(new Promise(e=>{s=e,setTimeout(e,50)}))})}stream(){return T(this,arguments,function*(){var e,t,r,n;if(this.state.streamWasCalled)throw new Error("stream can only be called once.");this.state.streamWasCalled=!0;for(const i of this.texts){this.state.partialText=i;try{for(var s,o=!0,a=(t=void 0,E(this._stream()));!(e=(s=yield b(a.next())).done);o=!0){n=s.value,o=!1;const e=n;yield yield b(e)}}catch(e){t={error:e}}finally{try{o||e||!(r=a.return)||(yield b(r.call(a)))}finally{if(t)throw t.error}}}})}}var C=function(e,t,r,n){return new(r||(r=Promise))(function(s,o){function a(e){try{l(n.next(e))}catch(e){o(e)}}function i(e){try{l(n.throw(e))}catch(e){o(e)}}function l(e){var t;e.done?s(e.value):(t=e.value,t instanceof r?t:new r(function(e){e(t)})).then(a,i)}l((n=n.apply(e,t||[])).next())})};let $=null,D=null;function R(e,r){t().runtime.sendMessage({action:"playbackState",state:e,error:r,originatingTabId:$}).catch(()=>{})}function U(){D&&(clearTimeout(D),D=null)}const I=new class{constructor(e={}){this.audioElement=null,this.isPlaying=!1,this.currentTTSDeactivate=null,this.callbacks=e}play(e,t){return C(this,void 0,void 0,function*(){var r,n,s,o;this.currentTTSDeactivate&&this.currentTTSDeactivate(),this.cleanup();try{null===(n=(r=this.callbacks).onLoading)||void 0===n||n.call(r);const s=(null==t?void 0:t.customVoice)||(null==t?void 0:t.voiceName)||"en-US-ChristopherNeural",o=(null==t?void 0:t.speed)||1.2,a=Math.round(100*(o-1)),i=new P(e,{voice:s,rate:a>=0?`+${a}%`:`${a}%`,connectionTimeout:1e4});return new Promise((e,t)=>{const r=new MediaSource;let n;const s=[];let o=!0,a=!0;this.currentTTSDeactivate=()=>{a=!1},this.audioElement||(this.audioElement=new Audio,this.audioElement.muted=!0,this.audioElement.src=URL.createObjectURL(r),this.audioElement.onplay=()=>{var e,t;this.audioElement&&(this.audioElement.muted=!1),this.isPlaying=!0,null===(t=(e=this.callbacks).onPlaying)||void 0===t||t.call(e)},this.audioElement.onpause=()=>{var e,t;this.isPlaying=!1,null===(t=(e=this.callbacks).onPaused)||void 0===t||t.call(e)},this.audioElement.onended=()=>{var e,t;this.isPlaying=!1,null===(t=(e=this.callbacks).onStopped)||void 0===t||t.call(e),this.cleanup()},this.audioElement.onerror=e=>{var t,r,n,s,o,a,i,l,c,g,m,u,d,A,h,f;const p={errorCode:null===(r=null===(t=this.audioElement)||void 0===t?void 0:t.error)||void 0===r?void 0:r.code,errorMessage:null===(s=null===(n=this.audioElement)||void 0===n?void 0:n.error)||void 0===s?void 0:s.message,errorType:1===(null===(a=null===(o=this.audioElement)||void 0===o?void 0:o.error)||void 0===a?void 0:a.code)?"MEDIA_ERR_ABORTED":2===(null===(l=null===(i=this.audioElement)||void 0===i?void 0:i.error)||void 0===l?void 0:l.code)?"MEDIA_ERR_NETWORK":3===(null===(g=null===(c=this.audioElement)||void 0===c?void 0:c.error)||void 0===g?void 0:g.code)?"MEDIA_ERR_DECODE":4===(null===(u=null===(m=this.audioElement)||void 0===m?void 0:m.error)||void 0===u?void 0:u.code)?"MEDIA_ERR_SRC_NOT_SUPPORTED":"UNKNOWN"};console.error("Audio playback error:",p),null===(A=(d=this.callbacks).onError)||void 0===A||A.call(d,(null===(f=null===(h=this.audioElement)||void 0===h?void 0:h.error)||void 0===f?void 0:f.message)||"Audio playback error"),this.cleanup()});const l=()=>{var e;if(a&&n&&"open"===r.readyState&&s.length>0&&!n.updating)try{const t=s.shift();if(t){const r=new Uint8Array(t.length);r.set(t),n.appendBuffer(r),o&&(w()?setTimeout(()=>{var e;null===(e=this.audioElement)||void 0===e||e.play().catch(e=>{console.warn("Firefox autoplay workaround failed:",e)})},0):null===(e=this.audioElement)||void 0===e||e.play().catch(e=>{console.warn("Audio playback failed:",e)}),o=!1)}}catch(e){console.error("appendNextChunk error:",e),s.shift(),a&&setTimeout(l,100)}};r.addEventListener("sourceopen",()=>{try{const o=w()?'audio/webm; codecs="opus"':"audio/mpeg";n=r.addSourceBuffer(o),n.addEventListener("updateend",l),(()=>{C(this,void 0,void 0,function*(){var o,c,g,m,u,d;try{let t=!1;try{for(var A,h=!0,f=function(e){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var t,r=e[Symbol.asyncIterator];return r?r.call(e):(e="function"==typeof __values?__values(e):e[Symbol.iterator](),t={},n("next"),n("throw"),n("return"),t[Symbol.asyncIterator]=function(){return this},t);function n(r){t[r]=e[r]&&function(t){return new Promise(function(n,s){!function(e,t,r,n){Promise.resolve(n).then(function(t){e({value:t,done:r})},t)}(n,s,(t=e[r](t)).done,t.value)})}}}(i.stream());!(o=(A=yield f.next()).done);h=!0){m=A.value,h=!1;const e=m;if(!a)return void(t=!0);if("audio"===e.type&&e.data){const t=new Uint8Array(e.data.byteLength);t.set(e.data),s.push(t),l()}}}catch(e){c={error:e}}finally{try{h||o||!(g=f.return)||(yield g.call(f))}finally{if(c)throw c.error}}t=!0;const u=()=>{if(a)if(t&&0===s.length&&!n.updating)try{"open"===r.readyState&&r.endOfStream(),e(void 0)}catch(t){e(void 0)}else setTimeout(u,100)};u()}catch(e){console.error("TTS streaming error:",e),null===(d=(u=this.callbacks).onError)||void 0===d||d.call(u,e.message||"TTS streaming error"),t(e)}})})()}catch(e){t(e)}})})}catch(e){throw console.error("TTS Error:",e),null===(o=(s=this.callbacks).onError)||void 0===o||o.call(s,e.message||"TTS initialization error"),this.cleanup(),e}})}togglePause(){this.audioElement&&(this.audioElement.paused?this.audioElement.play():this.audioElement.pause())}stop(){var e,t;this.audioElement&&(this.audioElement.pause(),this.audioElement.currentTime=0),this.cleanup(),null===(t=(e=this.callbacks).onStopped)||void 0===t||t.call(e)}getIsPlaying(){return this.isPlaying}hasAudio(){return null!==this.audioElement}cleanup(){if(this.currentTTSDeactivate&&(this.currentTTSDeactivate(),this.currentTTSDeactivate=null),this.audioElement){this.audioElement.onplay=null,this.audioElement.onpause=null,this.audioElement.onended=null,this.audioElement.onerror=null;const e=this.audioElement.src;this.audioElement.pause(),this.audioElement.src="",this.audioElement.load(),e&&e.startsWith("blob:")&&URL.revokeObjectURL(e)}this.audioElement=null,this.isPlaying=!1}}({onLoading:()=>R("loading"),onPlaying:()=>{U(),R("playing")},onPaused:()=>R("paused"),onStopped:()=>{U(),$=null,R("stopped")},onError:e=>{U(),$=null,R("error",e)}});t().runtime.onMessage.addListener(function(e,t,r){switch(console.log("Offscreen received message:",e.action),e.action){case"offscreen:readText":e.text&&($=e.originatingTabId||null,R("loading"),U(),D=setTimeout(()=>{console.warn("TTS playback timeout - no audio playing after 30 seconds"),R("error","TTS generation timed out. Please try again."),I.stop()},3e4),I.play(e.text,e.settings).catch(e=>{console.error("Offscreen TTS initialization error:",e),U(),R("error",(null==e?void 0:e.message)||"TTS initialization failed")}));break;case"offscreen:togglePlayback":I.togglePause();break;case"offscreen:stopPlayback":U(),I.stop();break;case"offscreen:getState":return r({isPlaying:I.getIsPlaying(),hasAudio:I.hasAudio()}),!0}}),console.log("Offscreen audio player initialized")})()})();